 <tool id="plot_metaMS" name="plot_metaMS" version="3.0.0">
       
    <description>GC-MS data preprocessing using metaMS package</description>

    <macros>
        <import>macros.xml</import>
    </macros>
    
    <expand macro="requirements"/>
    <expand macro="stdio"/>
    
    <command><![CDATA[
    LC_ALL=C Rscript $__tool_directory__/metaMS_plot.r
        
        metaMS $metaMS

        selecttic $selectedtic.TIC

        selectbpc $selectedbpc.BPC

        selecteic $selectedeic.EIC
        
        #if $selectedeic.EIC == "true"
            unkn "c($selectedeic.unkn)"
        #else
            unkn "none"
        #end if

        @COMMAND_LOG_EXIT@

    ]]></command>
    
    <inputs>

        <param name="metaMS" type="data" format="rdata" label="Rdata from new_metaMS_runGC" help="Rdata file containing a metaMS preprocess object" />

        <conditional name="selectedtic">
            <param name="TIC" checked="false" falsevalue="false" truevalue="true" label="Do you want to process for TIC(s) ?"  type="boolean">
                <option value="false">no</option>
                <option value="true">yes</option>
            </param>
            <when value="true"/>
            <when value="false"/>
        </conditional>
        <conditional name="selectedbpc">
            <param name="BPC" checked="false" falsevalue="false" truevalue="true" label="Do you want to process for BPC(s) ?"  type="boolean">
                <option value="false">no</option>
                <option value="true">yes</option>
            </param>
            <when value="true"/>
            <when value="false"/>
        </conditional>
        <conditional name="selectedeic">
            <param name="EIC" checked="false" falsevalue="false" truevalue="true" label="Do you want to process for EIC(s) ?"  type="boolean">
                <option value="false">no</option>
                <option value="true">yes</option>
            </param>
            <when value="true">
                <param name="unkn" type="text" value="1:5" label="EIC_Unknown" help="vector of peaks number to be plotted, for example 1:5 (mean 1 to 5) or 1,4,12  (means 1 4 and 12). For all EIC use 0" /> 
            </when>
            <when value="false"/>
        </conditional>

    </inputs>
    
    <outputs>
    
        <!-- Only when user selected TIC option -->
        <data name="ticsRawPdf"   format="pdf" from_work_dir="TICs_raw.pdf" label="TICs_raw.pdf">
            <filter>selectedtic['TIC'] is True</filter>
        </data>
        <!-- Only when user selected BPC option -->
        <data name="bpcsRawPdf"   format="pdf" from_work_dir="BPCs_raw.pdf" label="BPCs_raw.pdf">
            <filter>selectedbpc['BPC'] is True</filter>
        </data>
        <!-- Only when user selected EIC option -->
        <data name="unknownPdf"   format="pdf" from_work_dir="GCMS_EIC.pdf" label="GCMS_EIC.pdf">
            <filter>selectedeic['EIC'] is True</filter>
        </data>
        <data name="log" format="txt" from_work_dir="log.txt" label="plot_metaMS.log" />
        
    </outputs>
    
    <tests>
        <!-- Test TIC -->
        <test>
            <param name="metaMS" value="runGC_noDB.RData"  ftype="rdata" />
            <param name="selectedtic|TIC" value="true"/>
            <output name="ticsRawPdf" value="TICs_raw.pdf" ftype="pdf" compare="sim_size" delta="600"/>
        </test>
        <!-- Test BPC -->
        <test>
            <param name="metaMS" value="runGC_noDB.RData"  ftype="rdata" />
            <param name="selectedbpc|BPC" value="true"/>
            <output name="bpcsRawPdf" value="BPCs_raw.pdf" ftype="pdf" compare="sim_size" delta="600"/>
        </test>
        <!-- Test EICs -->
        <test>
            <param name="metaMS" value="runGC_noDB.RData"  ftype="rdata" />
            <param name="selectedeic|EIC" value="true"/>
            <output name="unknownPdf" value="GCMS_EIC.pdf" ftype="pdf" compare="sim_size" delta="600"/>
        </test>
    </tests>
    
    <help>
	
<!--
TODO : plotEIC not correct : we can't track the good unknown when we make EICs
TODO : Update the different tests
TODO : Verify the differents tests
TODO : Update the help section
-->

/!\\ WORK IN PROGRESS /!\\ 

.. class:: infomark

**Author(s)**  Ron Wehrens (ron.wehrens@gmail.com), Georg Weingart, Fulvio Mattivi

.. class:: infomark

**Galaxy wrapper and scripts developpers** Guitton Yann LABERCA yann.guitton@oniris-nantes.fr

.. class:: infomark

**Please cites**  
 
 metaMS : Wehrens, R.; Weingart, G.; Mattivi, F. Journal of Chromatography B.

 xcms :   Smith, C. A.; Want, E. J.; O’Maille, G.; Abagyan, R.; Siuzdak, G. Anal. Chem. 2006, 78, 779–787.

 CAMERA :   Kuhl, C.; Tautenhahn, R.; Böttcher, C.; Larson, T. R.; Neumann, S. Analytical Chemistry 2012, 84, 283–289.


---------------------------------------------------

====================
metaMS.runGC
====================

This tool will plot Base Peak Intensity chromatogram (BPI) and Total Ion Current chromatogram (TIC) from xcms experiments.

It will compare with opposite graphs your different classes given by a samplemetadata file or from xcms.findchrompeaks Merger tool.
  

-----------------
Workflow position
-----------------


**Upstream tools**

You can start from here or use result file from :

========================= ==================== ======= ==========
Name                      output file          format  parameter
========================= ==================== ======= ==========
xcms.xcmsSet              xset.RData RData     RData   file                     
========================= ==================== ======= ==========


**General schema of the metabolomic workflow for GCMS**

.. image:: ./static/images/gcms_workflow.png

-----------
Input files
-----------

If you choose to use results from xcms.xcmsSet

+---------------------------+------------+
| Parameter : num + label   |   Format   |
+===========================+============+
| 1 : RData file            |   RData    |
+---------------------------+------------+

Or converted GCMS files (mzML, CDF...) in your local libray 


----------
Parameters
----------

Parameters are described in metaMS R package and mainly correspond to those of xcms.xcmsSet

----------
Outputs
----------

The output file **dataMatrix.tsv** is an tabular file. You can continue your analysis using it in the statistical tools.
The output file **peakspectra.msp** is a text file. You can continue your analysis using it in the golm search tool. Or you can load it in your 
personnal NIST MSsearch program (c:/NISTXX/mssearch/nistms.exe) that tool is in general installed by default on GCMS apparatus. Tutorial available here_.

.. _here:  http://web11.sb-roscoff.fr/download/w4m/howto/w4m_HowToUseNIST_V01.pdf


----------------
Working Exemple
----------------
.. class:: warningmark  

**Reference Data for testing are taken from:**
Dittami,S.M. et al. (2012) Towards deciphering dynamic changes and evolutionary mechanisms involved in the adaptation to low salinities in Ectocarpus (brown algae): Adaptation to low salinities in Ectocarpus. The Plant Journal

Input files
-----------

    | **Zip file** -> GCMS_Idealg_FWS_SWS.zip

Parameters
----------

    | Settings -> **User_Defined**
    | RT range option -> **show**
        | RTrange: -> **4.5,45**
    | ...all default option values


Output files
------------

    | **1) rungc.RData: RData file**

    | **2) Example of BPCs_raw.pdf (Base Peak Chromatograms) :**

.. image:: ./static/images/metaMS_BPCs.png



---------------------------------------------------

Changelog/News
--------------

**Verion 2.2.0 - 02/03/2018**

- Upgrade metaMS from 1.8 to 1.14

**Version 2.1 - 08/06/2017**

- Quality: add sessionInfo logs with packages versions
- Processing: add RI usage 

**Version 1.1 - 11/07/2016**

- TEST: refactoring to pass planemo test using conda dependencies


**Version 1.0 - 01/06/2015**

- NEW: new tool

    </help>

    <citations>
        <citation type="doi">10.1016/j.jchromb.2014.02.051</citation>
        <citation type="doi">10.1093/bioinformatics/btu813</citation>
    </citations>

</tool>